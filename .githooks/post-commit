#!/bin/bash

if [ -n "$IN_POST_COMMIT_HOOK" ]; then
  exit 0
fi

export IN_POST_COMMIT_HOOK=1

REPO_URL="https://github.com/mannanj/mannan20"
OUTPUT_FILE="public/data/dev-commits.json"
METADATA_FILE="public/data/metadata.json"

mkdir -p "$(dirname "$OUTPUT_FILE")"

node -e "
const { execSync } = require('child_process');

const output = execSync(\`git log -9 --format='%H|||%h|||%s|||%b|||%an|||%aI|||---END---'\`, { encoding: 'utf-8', shell: '/bin/bash' });
const commits = [];
const entries = output.split('|||---END---\n').filter(e => e.trim());

entries.forEach(entry => {
  const parts = entry.split('|||');
  if (parts.length >= 6) {
    commits.push({
      fullHash: parts[0].trim(),
      hash: parts[1].trim(),
      subject: parts[2].trim(),
      body: parts[3].trim(),
      author: parts[4].trim(),
      date: parts[5].trim(),
      url: '${REPO_URL}/commit/' + parts[0].trim()
    });
  }
});

console.log(JSON.stringify(commits, null, 2));
" > "$OUTPUT_FILE"

node -e "
const { execSync } = require('child_process');
const latestDate = execSync('git log -1 --format=%aI', { encoding: 'utf-8', shell: '/bin/bash' }).trim();
console.log(JSON.stringify({ lastUpdated: latestDate }, null, 2));
" > "$METADATA_FILE"

if ! git diff --quiet "$OUTPUT_FILE" "$METADATA_FILE"; then
  git add "$OUTPUT_FILE" "$METADATA_FILE"
  git commit -m "Update dev data files" --no-verify
fi

exit 0
