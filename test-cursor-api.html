<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cursor API Debug Tool</title>
  <style>
    body {
      font-family: 'Lucida Grande', sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    h1 { color: #333; }
    h2 { color: #666; font-size: 18px; margin-top: 0; }
    button {
      background: #0070f3;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
    }
    button:hover { background: #0051cc; }
    pre {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
      font-size: 12px;
    }
    .status { padding: 10px; border-radius: 5px; margin: 10px 0; }
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .status.info { background: #d1ecf1; color: #0c5460; }
    input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px; }
    label { font-weight: bold; margin-right: 5px; }
  </style>
</head>
<body>
  <h1>Cursor API Debug Tool</h1>

  <div class="container">
    <h2>Connection Status</h2>
    <div id="status" class="status info">Initializing...</div>
  </div>

  <div class="container">
    <h2>Test /api/peers Endpoint</h2>
    <div>
      <label>Peer ID:</label>
      <input type="text" id="peerId" value="" readonly>
      <label>X:</label>
      <input type="number" id="x" value="100" style="width: 80px;">
      <label>Y:</label>
      <input type="number" id="y" value="200" style="width: 80px;">
      <label>Username:</label>
      <input type="text" id="username" value="debug-user">
      <label>Color:</label>
      <input type="color" id="color" value="#ff0000">
    </div>
    <div style="margin-top: 15px;">
      <button onclick="testPeersAPI()">Test API Call</button>
      <button onclick="startAutoPolling()">Start Auto-Polling (10s)</button>
      <button onclick="stopAutoPolling()">Stop Polling</button>
      <button onclick="clearLogs()">Clear Logs</button>
    </div>
  </div>

  <div class="container">
    <h2>API Response Log</h2>
    <pre id="apiLog">Waiting for first API call...</pre>
  </div>

  <div class="container">
    <h2>Console Logs</h2>
    <pre id="consoleLog">Console output will appear here...</pre>
  </div>

  <script>
    const API_BASE = window.location.hostname === 'localhost'
      ? 'http://localhost:3000/api'
      : '/api';

    let myPeerId = `debug-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    let pollingInterval = null;
    let apiCallCount = 0;

    document.getElementById('peerId').value = myPeerId;

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logEl = document.getElementById('consoleLog');
      const newLog = `[${timestamp}] ${message}\n`;
      logEl.textContent = newLog + logEl.textContent;

      console.log(message);
    }

    async function testPeersAPI() {
      apiCallCount++;
      const peerId = document.getElementById('peerId').value;
      const x = document.getElementById('x').value;
      const y = document.getElementById('y').value;
      const username = document.getElementById('username').value;
      const color = document.getElementById('color').value;

      const url = `${API_BASE}/peers?peerId=${encodeURIComponent(peerId)}&x=${x}&y=${y}&username=${encodeURIComponent(username)}&color=${encodeURIComponent(color)}`;

      log(`[Call #${apiCallCount}] Testing /api/peers...`);
      log(`URL: ${url}`);

      try {
        const startTime = performance.now();
        const response = await fetch(url);
        const endTime = performance.now();
        const duration = (endTime - startTime).toFixed(2);

        log(`Response status: ${response.status} ${response.statusText} (${duration}ms)`);

        if (response.ok) {
          const data = await response.json();
          const logEl = document.getElementById('apiLog');
          logEl.textContent = `[Call #${apiCallCount}] Response (${duration}ms):\n${JSON.stringify(data, null, 2)}\n\n${logEl.textContent}`;

          log(`‚úÖ Success! Received ${data.peers?.length || 0} peers`);
          document.getElementById('status').className = 'status success';
          document.getElementById('status').textContent = `‚úÖ Connected - Last call: ${duration}ms - Peers: ${data.peers?.length || 0}`;
        } else {
          const text = await response.text();
          log(`‚ùå Error: ${response.status} - ${text}`);
          document.getElementById('status').className = 'status error';
          document.getElementById('status').textContent = `‚ùå Error: ${response.status} ${response.statusText}`;
        }
      } catch (error) {
        log(`‚ùå Network error: ${error.message}`);
        document.getElementById('status').className = 'status error';
        document.getElementById('status').textContent = `‚ùå Network Error: ${error.message}`;

        const logEl = document.getElementById('apiLog');
        logEl.textContent = `[Call #${apiCallCount}] Error:\n${error.message}\n${error.stack}\n\n${logEl.textContent}`;
      }
    }

    function startAutoPolling() {
      if (pollingInterval) {
        log('‚ö†Ô∏è Polling already active');
        return;
      }
      log('‚ñ∂Ô∏è Starting auto-polling every 10 seconds...');
      testPeersAPI();
      pollingInterval = setInterval(testPeersAPI, 10000);
    }

    function stopAutoPolling() {
      if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
        log('‚è∏Ô∏è Polling stopped');
      } else {
        log('‚ö†Ô∏è Polling was not active');
      }
    }

    function clearLogs() {
      document.getElementById('apiLog').textContent = 'Logs cleared...';
      document.getElementById('consoleLog').textContent = 'Console cleared...';
      apiCallCount = 0;
      log('üßπ Logs cleared');
    }

    log(`Initialized with Peer ID: ${myPeerId}`);
    log(`API Base URL: ${API_BASE}`);
    testPeersAPI();
  </script>
</body>
</html>
